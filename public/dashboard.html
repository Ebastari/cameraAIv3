
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MONTANA V2 - REAL-TIME MAP DASHBOARD</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; background: #0f172a; }
    #map { height: 100vh; width: 100vw; z-index: 1; }
    
    .glass {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dark-glass {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }

    /* Custom Leaflet Styling */
    .leaflet-popup-content-wrapper {
      border-radius: 20px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .leaflet-popup-content { margin: 0; width: 300px !important; }
    .leaflet-container { font-family: 'Inter', sans-serif; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }

    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
      100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    .active-badge { animation: pulse-blue 2s infinite; }
  </style>
</head>
<body>

  <!-- Peta Full Screen -->
  <div id="map"></div>

  <!-- Top Header Overlay -->
  <div class="fixed top-6 left-1/2 -translate-x-1/2 z-[1000] w-[90%] max-w-4xl">
    <div class="glass p-4 rounded-3xl flex items-center justify-between shadow-2xl border border-white/50">
      <div class="flex items-center gap-4">
        <div class="bg-blue-600 p-2.5 rounded-2xl shadow-lg shadow-blue-500/30">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 20l-5.447-2.724A2 2 0 013 15.488V5.488a2 2 0 011.553-1.956L9 1l6 3 5.447-2.724A2 2 0 0121 3.236v10a2 2 0 01-1.553 1.956L15 18l-6 2z"/></svg>
        </div>
        <div>
          <h1 class="font-black text-slate-900 text-lg leading-none tracking-tighter">MONTANA DASHBOARD <span class="text-blue-600">V2.1</span></h1>
          <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">Sistem Monitoring Terintegrasi Google Cloud</p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <div id="status-badge" class="hidden md:flex items-center gap-2 bg-emerald-50 text-emerald-600 px-4 py-2 rounded-2xl border border-emerald-100">
          <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
          <span class="text-[10px] font-black uppercase tracking-widest">Sistem Online</span>
        </div>
        <button onclick="refreshData()" class="bg-white hover:bg-slate-50 text-slate-700 p-3 rounded-2xl border border-slate-200 shadow-sm transition-all active:scale-90">
          <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Left Sidebar Panel (Stats & Filters) -->
  <div class="fixed top-32 left-8 z-[1000] w-80 space-y-4 hidden lg:block">
    <!-- Search Box -->
    <div class="glass p-5 rounded-[2.5rem] shadow-xl border border-white/40">
      <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1">Cari Nomor Pohon</h3>
      <div class="relative">
        <input type="text" id="search-input" onkeyup="filterBySearch()" placeholder="Contoh: 104..." class="w-full bg-white/50 border border-slate-200 rounded-2xl py-3 px-10 text-sm font-bold focus:ring-4 focus:ring-blue-500/10 outline-none transition-all">
        <svg class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="glass p-6 rounded-[2.5rem] shadow-xl border border-white/40 space-y-6">
      <div class="flex flex-col">
        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Total Realisasi</span>
        <div class="flex items-baseline gap-2 mt-1">
          <h2 id="stat-total" class="text-5xl font-black text-slate-900 leading-none">0</h2>
          <span class="text-xs font-bold text-slate-400">Pohon</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-emerald-500/10 border border-emerald-100 p-4 rounded-3xl">
          <p class="text-[8px] font-black text-emerald-600 uppercase tracking-widest">Sehat</p>
          <p id="stat-sehat" class="text-xl font-black text-emerald-700 mt-1">0</p>
        </div>
        <div class="bg-amber-500/10 border border-amber-100 p-4 rounded-3xl">
          <p class="text-[8px] font-black text-amber-600 uppercase tracking-widest">Merana</p>
          <p id="stat-merana" class="text-xl font-black text-amber-700 mt-1">0</p>
        </div>
      </div>

      <div class="pt-4 border-t border-slate-200/50">
        <h4 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">Jenis Bibit Dominan</h4>
        <div id="species-stats" class="space-y-3">
          <!-- Dinamis -->
        </div>
      </div>
    </div>
  </div>

  <!-- Legend Bottom Right -->
  <div class="fixed bottom-10 right-10 z-[1000]">
    <div class="glass p-4 rounded-3xl shadow-xl flex flex-col gap-3">
      <div class="flex items-center gap-3">
        <div class="w-3 h-3 rounded-full bg-[#10b981] shadow-[0_0_8px_#10b981]"></div>
        <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Sehat</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="w-3 h-3 rounded-full bg-[#f59e0b] shadow-[0_0_8px_#f59e0b]"></div>
        <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Merana</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="w-3 h-3 rounded-full bg-[#ef4444] shadow-[0_0_8px_#ef4444]"></div>
        <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Mati</span>
      </div>
    </div>
  </div>

  <script>
    // KONFIGURASI
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_lxW9C6HYzFLlrJmY9PuQNDKx1UUwjdKsdpVs8rtWgJxFcAmFg-MIYRT5zlkjH5aoDQ/exec';
    
    let map, markersLayer;
    let rawData = [];
    const HEALTH_COLORS = { 'Sehat': '#10b981', 'Merana': '#f59e0b', 'Mati': '#ef4444' };

    // Inisialisasi Peta
    function initMap() {
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      }).setView([-2.979129, 115.199507], 16);

      // Layer Satelit
      const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
      
      // Tambahkan kontrol zoom manual ke pojok kanan
      L.control.zoom({ position: 'bottomright' }).addTo(map);
    }

    // Helper: Gambar HD dari Drive
    function getHighResImageUrl(url) {
      if (!url) return '';
      const driveIdMatch = url.match(/\/d\/([^/]+)/) || url.match(/[?&]id=([^&]+)/);
      if (driveIdMatch && driveIdMatch[1]) {
        return `https://drive.google.com/thumbnail?id=${driveIdMatch[1]}&sz=w800`;
      }
      return url;
    }

    // Fetch Data
    async function refreshData() {
      const btnIcon = document.getElementById('refresh-icon');
      btnIcon.classList.add('animate-spin');
      
      try {
        const response = await fetch(APPS_SCRIPT_URL);
        const data = await response.json();
        
        if (Array.isArray(data)) {
          rawData = data;
          renderMarkers(data);
          updateStats(data);
        }
      } catch (err) {
        console.error("Gagal memuat data:", err);
      } finally {
        setTimeout(() => btnIcon.classList.remove('animate-spin'), 1000);
      }
    }

    function renderMarkers(data) {
      markersLayer.clearLayers();
      let lastLatLng = null;

      data.forEach(item => {
        // Parsing koordinat dari string Apps Script
        const lat = parseFloat(String(item.X).replace(',', '.'));
        const lon = parseFloat(String(item.Y).replace(',', '.'));

        if (!isNaN(lat) && !isNaN(lon)) {
          const color = HEALTH_COLORS[item.Kesehatan] || '#3b82f6';
          
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: color,
            color: 'white',
            weight: 3,
            fillOpacity: 0.9
          });

          // Custom Popup UI
          const popupHtml = `
            <div class="bg-white">
              <div class="relative h-44 w-full bg-slate-100">
                <img src="${getHighResImageUrl(item["Link Drive"])}" class="w-full h-full object-cover" />
                <div class="absolute top-3 right-3 bg-black/60 backdrop-blur-md px-2 py-1 rounded-lg">
                  <span class="text-white text-[9px] font-black uppercase tracking-widest">#${item["No Pohon"]}</span>
                </div>
              </div>
              <div class="p-4 space-y-3">
                <div class="flex justify-between items-start">
                  <div>
                    <h3 class="font-black text-slate-800 uppercase text-xs leading-none">POHON ${item["No Pohon"]}</h3>
                    <p class="text-[10px] font-bold text-blue-600 uppercase mt-1">${item.Tanaman}</p>
                  </div>
                  <span class="text-[8px] font-black px-2 py-0.5 rounded-full text-white" style="background:${color}">
                    ${String(item.Kesehatan).toUpperCase()}
                  </span>
                </div>
                <div class="grid grid-cols-2 gap-2 border-y border-slate-50 py-3">
                  <div>
                    <p class="text-[7px] text-slate-400 font-black uppercase">Tinggi</p>
                    <p class="text-xs font-black text-slate-700">${item.Tinggi} CM</p>
                  </div>
                  <div>
                    <p class="text-[7px] text-slate-400 font-black uppercase">Tahun Tanam</p>
                    <p class="text-xs font-black text-slate-700">${item["Tahun Tanam"] || '-'}</p>
                  </div>
                </div>
                <div class="space-y-0.5 pt-1">
                  <p class="text-[9px] font-black text-slate-800 uppercase leading-none">${item.Pengawas}</p>
                  <p class="text-[8px] text-slate-400 italic">${item.Tanggal}</p>
                </div>
              </div>
            </div>
          `;

          marker.bindPopup(popupHtml);
          markersLayer.addLayer(marker);
          lastLatLng = [lat, lon];
        }
      });

      if (lastLatLng) map.flyTo(lastLatLng, 17);
    }

    function updateStats(data) {
      document.getElementById('stat-total').textContent = data.length;
      document.getElementById('stat-sehat').textContent = data.filter(d => d.Kesehatan === 'Sehat').length;
      document.getElementById('stat-merana').textContent = data.filter(d => d.Kesehatan === 'Merana').length;

      // Species Breakdown
      const speciesCount = {};
      data.forEach(d => {
        speciesCount[d.Tanaman] = (speciesCount[d.Tanaman] || 0) + 1;
      });

      const speciesHtml = Object.entries(speciesCount)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 4)
        .map(([name, count]) => `
          <div class="space-y-1">
            <div class="flex justify-between text-[10px] font-black uppercase tracking-tighter">
              <span class="text-slate-600">${name}</span>
              <span class="text-blue-600">${count}</span>
            </div>
            <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500 rounded-full" style="width: ${(count/data.length*100).toFixed(0)}%"></div>
            </div>
          </div>
        `).join('');
      
      document.getElementById('species-stats').innerHTML = speciesHtml;
    }

    function filterBySearch() {
      const q = document.getElementById('search-input').value.toLowerCase();
      if (!q) {
        renderMarkers(rawData);
        return;
      }
      const filtered = rawData.filter(d => 
        String(d["No Pohon"]).toLowerCase().includes(q) || 
        String(d.Tanaman).toLowerCase().includes(q)
      );
      renderMarkers(filtered);
    }

    // Jalankan saat load
    window.onload = () => {
      initMap();
      refreshData();
      // Auto refresh tiap 60 detik
      setInterval(refreshData, 60000);
    };
  </script>
</body>
</html>
